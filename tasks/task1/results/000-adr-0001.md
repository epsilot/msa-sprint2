**Название задачи:** ADR-0001. План перевода монолитной архитектуры приложение Hotelio на микросервисную архитектуру

**Автор:** Фарков Михаил

**Дата:** 30.09.2025

## Контекст

Монолитная реализация приложения не соответствует текущим требованиям бизнеса с точки зрения роста клиентской базы,
надёжности работы и скорости разработки новой функциональности. Необходимо подготовить годовой план поэтапного перевода
текущей монолитной архитектуры на микросервисную.

## Требования

### Функциональные требования

В рамках перехода к микросервисной архитектуры функциональные требования остаются неизменными. При приоретизации
разработки новой функциональности требуется учитывать текущее состояние миграции компонентов системы, к которой
относится новая функциональность. Это необходимо, чтобы минимизировать добавление новой комплексной функциональности в
компоненты монолита.

### Нефункциональные требования

| Код | Требование                                                                                                        |
|-----|-------------------------------------------------------------------------------------------------------------------|
| R1  | Сохранять работоспособность основных компонент системы в случае сбоя во вспомогательных компонентах               |
| S1  | Обеспечить возможность независимой разработки и тестирования различных компонент системы различными командами     |
| S2  | Предусмотреть возможность создания API специализированного под конкретные платформы                               |
| P1  | Обеспечить возможность независимого масштабирования различных компонент система в соответсвии с текущей нагрузкой |


## Решение

- Текущая архитектура включает в себя следующие домены ([диаграмма 001-ddd-strategic](./001-ddd-strategic.puml)):
  - Управление отелями (H)
  - Управление бронированиями (B)
  - Управление пользователями (U)
  - Управление промо кодами (P)
- Следует выделить основные пользовательские сценарии взаимодействия с системой.

| Код | Сценарий                 | Основные задействованные компоненты | Описание                                                                                                      |
|-----|--------------------------|-------------------------------------|---------------------------------------------------------------------------------------------------------------|
| UC1 | Подбор отелей            | H                                   | Пользователь (не обязательно авторизованный) выполняет поиск и фильтрацию отелей согласно требуемым критериям |
| UC2 | Просмотр бронирований    | B, U, H                             | Авторизованный пользователь просматривает информацию о своих бронированиях текущих и прошедших                |
| UC3 | Изменение Бронирования   | B, U                                | Пользователь выполняет, изменяет, отменяет бронирование                                                       |
| UC4 | Регистрация пользователя | U                                   | Выполнение регистрации нового пользователя                                                                    |
| UC5 | Авторизация пользователя | U                                   | Выполнение авторизации пользователя                                                                           |
| UC6 | Применение промокода     | P, B, H                             | Пользователь применяет промокод при подборе, либо выполнении оплаты                                           |
| UC7 | Оставление отзыва        | H                                   | Пользователь оценивает отель и добавляет отзыв                                                                |
| UC8 | Оплата бронирования      | B                                   | Пользователь вводит даннные необходимые для оплаты бронирования                                               |

- Согласно текущим бизнес задачам к основным компонентам системы можно отнести управление пользователями, управление
  бронированием и управление отелями. Вспомогательными задачами следует считать работу с промо кодами и отзывами на
  отели.
- Такое разделение следует принимать во внимания при организации разбиения на микросервисы.
- Важно учитывать, что с точки зрения бизнеса и пользовательского опыта работоспособность компонента управления отелями
  является критически важной, так как это является стартовой точкой взаимодействия пользователя с системой (UC1).
- Компоненты управления бронированием и управления пользователями также являются важными, но при этом, с точки зрения
  положительного пользовательского опыта являются менее критичными, так как относятся к менее частым пользовательским
  сценариям (UC2, UC3).
- Компоненты ответственные за работу с промо кодами, а также отзывами на отели не являются критически важными,
  однако следует понимать, что проблемы с работоспособностью компонента управления промо кодами может снизить
  конверсию пользователей в успешное бронирование (UC6, UC8), так как это повлияет на итоговую стоимость бронирования.
- Ключевым недостатком текущей монолитной архитектуры является наличие большого количества зависимостей в ключевом
  компоненте управления бронированиями, таким образом неработоспособность каких-либо вспомогательных компонент будет
  негативно влиять как на пользовательский опыт, так и на конверсию пользователя в успешное бронирование.

### Выделение микросервисов

- Согласно основным бизнес задачам следует выделить следующие микросервисы:
  - Микросервис бронирования
  - Микросервис отелей
  - Микросервис промо кодов
  - Микросервис пользователей
- Работа с отзывами является вспомогательной задачей. Однако, на текущем этапе её выделение в отдельный микросервис
  кажется избыточным из-за простоты реализации, а также тесной связи с задачей управления отелями. Кроме того,
  немаловажно учесть, что фильтрация отелей в процессе подбора по рейтингу видится частым пользовательским сценарием.
  Разделение управления отелями и работу с отзывами на различные микросервисы значительно усложнит гибкое выполнение
  фильтрации. Более подробная информация изложена в разделе с [альтернативами](#альтернативы).

### Определение порядка реализации

- Порядок перехода микросервисов следует определить следующим образом:
  - Микросервис пользователей / Микросервис промо кодов
  - Микросервис отелей
  - Микросервис бронирования
- Микросервис пользователей и микросервис промо кодов имеют одинаковый приоритет с точки зрения стартового микросервиса
  реализации. Микросервис пользователей является критически важным компонентом, но при этом он является в значительной
  степени независимым от остальных компонент, что должно упростить его реализацию. Микросервис промо кодов видится
  достаточно простым в реализации и будет являться хорошей стартовой точкой для команды разработчиков. Итоговое решение
  следует дополнительно обсудить с командой разработчиков.
- Микросервис бронирования требует наибольшего взаимодействия с другими микросервисами и внешними системами
  (например с биллингом), при этом является критически важным с точки зрения показателей бизнеса. Таким образом его 
  перенос на микросервисную архитектуру следует выполнять в последнюю очередь, после отработки процесса на более
  простых микросервисах.


### Общие детали реализации

- Разворачивание микросервисов предполагается в кластере Kubernetes с использованием Istio service mesh. Как наиболее
  стабильного и универсального решения.
- Для поддержания согласованности между микросервисами (в ситуациях не требующих синхронного взаимодействия), а также
  для обеспечения надёжности обработки команд в системе будет использован кластер Kafka.
- Маршрутизация клиентских запросов будет обеспечиваться по средствам федеративного GraphQL, что позволит обеспечить
  независимость разработки различных микросервисов и минимизирует объём передаваемых данных.
- На этапе миграции REST API монолитной архитектуры будет доступно для обеспечения постепенного перехода к новой
  архитектуре, что позволит вносить изменения в клиенты поэтапно.
- Также на этапе миграции следует предусмотреть реализацию ACL для организации обмена между микросервисами и монолитом.
- Итоговое целевое состояние системы отражено на [диаграмме](./002-c2-target.puml).

## Альтернативы

- В качестве основной альтернативы можно рассмотреть выделение управления отзывами на отели в отдельный микросервис.
- В пользу такого решения говорит потенциальная необходимость выполнять комплексную модерацию оставляемых отзывов,
  бороться с различными практиками завышения или занижения рейтингов, а также необходимость подготавливать детальную
  аналитику на основании различных критериев удовлетворённости гостей.
- Реализация такой функциональности в микросервисе управления отелями может привести к излишним усложнениям.
- При этом для ускорения ранжирования и фильтрации отелей на основании отзывов можно предусмотреть асинхронную
  денормализацию данных между микросервисом отзывов и микросервисов отелей. Это может привести к задержке обновления
  рейтинга отелей, однако это не видится критичным с точки зрения бизнес метрик и качества пользовательского опыта.

## Недостатки, ограничения, риски

- Поэтапная миграция позволит достаточно гибко управлять стандартными рисками, связанными с переходом на микросервисную
  архитектуру.
- Ключевым риском для успешного выполнения миграции в установленный срок является ограниченность
  доступных рабочих ресурсов, а также отсутствие опыта эксплуатации систем с использованием GraphQL. Что можно
  адресовать путём расширения штата DevOps инженеров, либо повышением квалификации в требуемых областях.