stages:
  - build
  - test
  - deploy

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: booking-service

build:
  stage: build
  script:
    - sudo docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./booking-service

test:
  stage: test
  script:
    - sudo docker run --rm -d --name=booking-service -p 8080:8080 ${IMAGE_NAME}:${IMAGE_TAG}
    - curl -s http://localhost:8080/ping | grep -q "^pong" && echo "Success" || (echo "Failure" && exit 1)
    - sudo docker stop booking-service

deploy:
  stage: deploy
  script:
    - minikube image load ${IMAGE_NAME}:${IMAGE_TAG}
    - cd helm && helm upgrade booking-service booking-service -f ../results/values-prod.yaml